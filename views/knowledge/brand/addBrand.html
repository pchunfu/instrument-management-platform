<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <title>添加牌号</title>

  <link rel="stylesheet" href="../../../assets/libs/layui/css/layui.css" />
  <link rel="stylesheet" href="../../../assets/module/admin.css?v=318" />
  <script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
  <script type="text/javascript" src="../../../assets/libs/layui/layui.js"></script>
  <script type="text/javascript" src="../../../assets/js/common.js?v=318"></script>
  <script type="text/javascript" src="../../../assets/js/util.js?v=318"></script>
  <script type="text/javascript" src="../../../assets/js/url.js?v=318"></script>
  <script type="text/javascript" src="../../../assets/js/htmlUtil.js?v=318"></script>

  <style>
    body {
      margin: 10px;
    }
    x {
     color: red;
    }
  </style>
</head>

<body>
  <form id="form" class="layui-form" action="">

    <div class="layui-form-item">
      <div class="layui-inline">
        <label class="layui-form-label" style="width:110px;  margin-left: 25px">
          <x>*&nbsp</x>国标编号
        </label>
        <div class="layui-input-inline">
          <select name="modules" lay-verify="required" lay-search="" id="country">
            <option value="">直接选择或搜索选择</option>
          </select>
        </div>
      </div>
    </div>
    <div class="layui-form-item">
      <label class="layui-form-label" style="width: 110px; margin-left: 25px">
        <x>*&nbsp</x>牌号名称
      </label>
      <div class="layui-input-inline">
        <input type="text/number" oninput="if(value.length>20)value=value.slice(0,20)" id="brandName" name="brandName" lay-verify="required" autocomplete="off" placeholder="请输入牌号名称" class="layui-input" style="width: 190px;">
      </div>
    </div>

    <table class="layui-table" id="demo" lay-filter="addBrand" lay-data="{id:'idTest'}" id="addBrand"></table>

    <script type="text/html" id="switchTpl">
      <input type="checkbox" id="essential" name="isEssential" lay-skin="primary" value="{{d.isEssential}}" lay-filter="isEssential" {{ d.isEssential == 'true' ? 'checked' : '' }}>

  </script>

    <script type="text/html" id="brandName">
      <a class="layui-text" id="name" lay-event="brandName"></a>
  </script>
    <div class="layui-form-item" style="margin-left: 120px">
      <div class="layui-input-block" style="margin: 20px 22 0px">
        <button type="submit" class="layui-btn" lay-submit="" lay-filter="demo1">添加</button>
      </div>
    </div>
  </form>

  <script>
    resize();
    layui.use(['form', 'table'], function() {
      var form = layui.form,
        layer = layui.layer,
        table = layui.table;

      var tableData = table.render({
        elem: '#demo',
        height: 615,
        height: 'full-275',
        page: true //开启分页
          ,
        cols: [
            [ //表头
              {
                field: 'elem',
                title: '元素名称',
                width: 100,
                align: 'center',
                unresize: true
              }, {
                field: 'min',
                title: '下限(%)',
                width: 150,
                align: 'center',
                edit: 'text',
                unresize: true
              }, {
                field: 'max',
                title: '上限(%)',
                width: 150,
                align: 'center',
                edit: 'text',
                unresize: true
              }, {
                field: 'isEssential',
                title: '是否关键',
                templet: '#switchTpl',
                align: 'center',
                unresize: true
              }
            ]
          ],
        data: [{
          "elem": "Fe",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "Cd",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "Zn",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "Al",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "Sn",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "Mo",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "Co",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "Ag",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "Si",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "Mn",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "Au",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "Sb",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "Pb",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "Ti",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "Ni",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "S",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "P",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "Bi",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "V",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "W",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "Mg",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "N",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "Se",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "B",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "C",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "Cu",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "Zr",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "La",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "Sr",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "Nb",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "As",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "Ga",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "Te",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "Cr",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "Be",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "Ce",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }, {
          "elem": "Ca",
          "min": "0.000",
          "max": "0.000",
          "isEssential": "false"
        }],
        even: true,
        done: function(res, curr, count) {

        }
      });

      $.ajax({
        url: initCountryStandardUrl(),
        dataType: 'json',
        type: 'get',
        success: function(result) {
          $.each(result.data, function(index, item) {
            $('#country').append(new Option(item.countryName, item.countryId)); //往下拉菜单里添加元素
          });
          form.render();
        }
      });

      var myIndex = 0;
      form.on('submit(demo1)', function(data) {
        var brandName = data.field.brandName;

        var checkName = /^[a-zA-Z0-9\/\-_\#\u4E00-\u9FA5]{2,20}$/;
        if (checkName.test(brandName) == false) {
          alert("牌号名称为:汉字、数字、字母以及 _ - / #");
          return false;
        }

        var brandData = tableData.config.data;
        $.each(brandData, function(index, item) {
          brandData[index] = table.clearCacheKey(item)
        });
        // alert(JSON.stringify(brandData));
        $.each(brandData, function(index, item) {
          var checkFormat = /^(0)$|^100$|^[1-9][0-9]?$/.test('100');;
          if (brandData[index].min > 100 || brandData[index].max > 100) {
            alert("请输入正确的数字格式(小于100)");
            myIndex = 1;
            return;
          }
          if (brandData[index].max < brandData[index].min) {
            myIndex = 1;
            alert("上限要大于下限");
            return false;
          }
        });
        if (myIndex == 1) {
          return false;
        }

        $.ajax({
          url: addBrandUrl(),
          type: "post", // 采用post方法
          dataType: "json", // 请求和返回的参数格式；如果是非json格式需要使用text格式
          contentType: 'application/json; charset=utf-8',
          async: false,
          // 获取id=loginForm的form表单中的参数
          data: JSON.stringify({
            "countryStandardId": data.field.modules,
            "brandName": brandName,
            "elementModes": brandData,
            "index": myIndex
          }),
          // 当接口调用成功时，执行success中的方法，result参数指的是接口返回的信息
          success: function(result) {
            if (result.code == 0) {
              //关闭图层
              alert(result.msg);
              //先取到该子页面在父级页面中的name 值
              var index = parent.layer.getFrameIndex(Window.name);
              parent.layer.closeAll();
            } else {
              alert(result.msg);
            }
          },
          error: function() {
            alert("服务器忙……请稍后重试！");
          }
        });
      })
      //监听单元格编辑
      table.on('edit(addBrand)', function(obj) {
        var value = obj.value //得到修改后的值
          ,
          data = obj.data //得到所在行所有键值
          ,
          field = obj.field; //得到字段



        //    var checkFormat = /^[0-9]{1}[0-9.]{3}[0-9]{1}$/;
        //     // var checkFormat = /^(?!0+(?:\.0+)?$)(?:[1-9]\d*|0)(?:\.\d{1,5})?$/;
        //    if(checkFormat.test(value) == false){
        //      alert("请输入正确的数字格式(5位小数以内)");
        //      return false;
        // }

      });

      //表单取值
      layui.$('#LAY-component-form-getval').on('click', function() {
        var data = form.val('example');
      });
    });
  </script>
</body>

</html>
